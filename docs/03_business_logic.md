# ビジネスロジック設計書

## 1. 価格計算ロジック

### 買取減額計算（`app/lib/pricing.ts` - `calculateBuybackDeduction`）

**基準:** 美品ランクの買取価格に対するパーセンテージ減額

| 条件 | 減額率 |
|------|--------|
| バッテリー 90%未満 | 美品価格の 10% |
| バッテリー 80%未満 or サービス状態 | 美品価格の 20% |
| NW利用制限 △ | 美品価格の 20% |
| NW利用制限 × | 美品価格の 40% |
| カメラ染み（大小問わず） | 美品価格の 20% |
| カメラ窓割れ | 美品価格の 10% |
| 非正規修理歴あり | 美品価格の 20% |

**計算式:** `最終買取価格 = 基本買取価格 - 合計減額`
（合計減額は上記条件の該当分を合算。各条件は累積）

### 販売減額計算（`app/lib/pricing.ts` - `calculateSalesDeduction`）

**基準:** `m_sales_price_deductions` テーブルから固定金額を取得

| deduction_type | 説明 |
|----------------|------|
| battery_80_89 | バッテリー80-89%の減額 |
| battery_79 | バッテリー79%以下の減額 |
| camera_stain_minor | カメラ染み（少）の減額 |
| camera_stain_major | カメラ染み（多）の減額 |
| nw_triangle | NW利用制限△の減額 |
| nw_cross | NW利用制限×の減額 |

### 税計算ルール（重要）

消費税率: 10% 固定

**【カテゴリ別の税処理】**

| カテゴリ | 入力 | DB保存 | Square送信 |
|---------|------|--------|-----------|
| 中古販売 | 税込 | 税込 | そのまま |
| 修理・データ移行・操作案内・アクセサリ | 税抜 | 税抜 | ×1.1（税込変換） |

**【中古販売の価格フロー】**

```
1. 買取時: m_sales_prices（税抜基準価格）から販売価格を自動計算
   → (基準価格 - 減額) × 1.1 = 税込販売価格
   → t_used_inventory.sales_price に保存

2. 在庫管理: 販売価格は税込で表示・編集
   → 変更時もそのまま税込で保存

3. 売上登録: 在庫の販売価格をそのまま使用
   → 減額計算は行わない（在庫登録時に済んでいる）
   → Squareにはそのまま送信（既に税込）
```

**【その他商材の価格フロー】**

```
1. マスタ: 税抜価格で管理
2. 入力: 税抜価格で入力
3. 表示: 税抜で表示
4. Square送信: ×1.1 + 端数処理で税込変換
```

**【端数処理】**
- 末尾1, 2 → 切捨て（例: 1081 → 1080）
- 末尾8, 9 → 切上げ（例: 1088 → 1090）
- 末尾3-7 → そのまま

---

## 2. 在庫滞留日数の計算

```typescript
const days = Math.floor((today - arrivalDate) / (1000 * 60 * 60 * 24))
```

| 日数 | バッジ色 |
|------|---------|
| 45日未満 | グレー |
| 45日以上 | 青 |
| 60日以上 | 黄 |
| 90日以上 | 黄 |
| 120日以上 | 赤 |

---

## 3. 保証期間計算

販売日から360日間の保証。60日ごとに返金率が10%ずつ減少。

| 期間 | 返金率 | 顧客負担修理率 |
|------|--------|--------------|
| 0-59日 | 100% | 0%（無償修理） |
| 60-119日 | 90% | 10% |
| 120-179日 | 80% | 20% |
| 180-239日 | 70% | 30% |
| 240-299日 | 60% | 40% |
| 300-359日 | 50% | 50% |
| 360日以降 | 保証終了 | - |

---

## 4. 和暦変換ロジック

```typescript
const toWareki = (dateStr: string): string => {
  if (!dateStr) return ''
  const date = new Date(dateStr)
  const year = date.getFullYear()
  const month = date.getMonth() + 1
  const day = date.getDate()
  if (year >= 2019) return `令和${year - 2018}年${month}月${day}日`
  if (year >= 1989) return `平成${year - 1988}年${month}月${day}日`
  if (year >= 1926) return `昭和${year - 1925}年${month}月${day}日`
  if (year >= 1912) return `大正${year - 1911}年${month}月${day}日`
  return `明治${year - 1867}年${month}月${day}日`
}
```

---

## 5. 修理種別と排他制御

`app/lib/constants.ts` で定義。

| key | label | partsType | 排他 | 色モデル限定 |
|-----|-------|-----------|------|-------------|
| TH-L | 標準パネル(黒) | TH-L | TH-F | - |
| TH-F | 標準パネル(白) | TH-F | TH-L | Yes |
| HG-L | HGパネル(黒) | HG-L | HG-F | - |
| HG-F | HGパネル(白) | HG-F | HG-L | Yes |
| battery | 標準バッテリー | バッテリー | - | - |
| hg_battery | HGバッテリー | HGバッテリー | - | - |
| connector | コネクタ | コネクタ | - | - |
| rear_camera | リアカメラ | リアカメラ | - | - |
| front_camera | インカメラ | インカメラ | - | - |
| camera_glass | カメラ窓 | カメラ窓 | - | - |

**色モデル:** SE, 6s, 7, 7P, 8, 8P（白パネルが存在）

### パーツ共有グループ

同じパーツを使うモデルは在庫を合算表示:
- **8/SE2**: TH, HG, コネクタ を共有
- **12/12Pro**: TH, HG, バッテリー, HGバッテリー, コネクタ を共有

---

## 6. 買取フロー（店頭）

```
1. 買取種別選択（店頭/郵送）
2. 端末情報入力
   - 機種・容量・ランク・カラー
   - IMEI・バッテリー・NW・カメラ・修理歴
3. 価格計算
   - m_buyback_prices から基本価格取得
   - calculateBuybackDeduction で減額計算
   - m_buyback_guarantees で最低保証確認
4. お客様画面（iPad渡し）
   - 価格提示
5. 動作チェック（20項目）
6. 顧客情報入力
   - 氏名・生年月日・住所・職業・電話番号
   - 本人確認書類
   - 18歳未満の場合は保護者情報
   - 同意書（6項目チェック）
7. 本人確認・確定
8. 支払い（現金/振込）
   - 振込の場合: 口座情報入力
   - Slack・メール通知送信
```

### 同意書6項目

1. 合法的所有者であり売却する権利を有する
2. 盗難品・紛失品でなく法的紛争の対象でない
3. 買取業者は上記買取価格を支払う
4. 売却者は一切の権利を買取業者に譲渡する
5. 買取価格支払い時点で効力発生
6. NW利用制限が「×」になる場合は全額返金する

---

## 7. 売上カテゴリ

| category | 説明 |
|----------|------|
| 修理 | iPhone/iPad/Android の修理 |
| 中古販売 | 中古端末の販売 |
| アクセサリ | アクセサリ商品の販売 |
| データ移行 | データ移行サービス |
| 操作案内 | 操作案内サービス |

---

## 8. Square POS連携

### 決済手数料率

| 決済方法 | 手数料率 |
|----------|---------|
| クレジットカード | 2.5% |
| 電子マネー | 3.25% |
| QRコード | 3.25% |
| 現金 | 0% |

### Webhook処理

1. `payment.created/updated` → COMPLETED: 売上作成/更新
2. `payment.created/updated` → CANCELED/VOIDED: 売上取消、在庫復旧
3. `refund.created/updated` → COMPLETED: 返金処理、在庫復旧

---

## 9. 機種選択UI（シリーズ別グループ）

プルダウンは `<optgroup>` でシリーズ別にグループ化:
- 17シリーズ: iPhone 17, iPhone 17 Pro, iPhone 17 Pro Max, iPhone Air
- 16シリーズ: iPhone 16, iPhone 16 Plus, iPhone 16 Pro, iPhone 16 Pro Max, iPhone 16e
- 15シリーズ: ...

並び順: `sort_order DESC`（新しいモデルが先頭）

グルーピングロジック:
- モデル名の数字プレフィクスでグループ化
- 例外: `Air` → 17シリーズ、`16e` → 16シリーズ

---

## 10. レポート・KPI

### KPI項目

| KPI | 計算方法 |
|-----|---------|
| OLED修理率 | HG-L/HG-F修理件数 / 全修理件数 |
| パネル+バッテリー同時率 | パネル+バッテリー同時修理 / パネル修理件数 |
| フィルム販売率 | フィルム販売件数 / 修理件数 |
| 中古販売率 | 中古販売件数 / 全販売件数 |
| アクセサリ客単価 | アクセサリ売上 / アクセサリ販売件数 |

### 売上目標

- 月次目標: `m_sales_targets` テーブルで店舗別に管理
- 日別・平日/土日・休日で按分計算
- 進捗率を可視化
