# システム分析レポート

## 1. 現在のテーブル構造

### 修理関連
| テーブル | 用途 | キー項目 |
|---------|------|---------|
| m_repair_prices_iphone | 修理価格 | model, repair_type |
| m_costs_hw | パーツ原価 | model, parts_type, supplier_id |
| t_parts_inventory | パーツ在庫 | model, parts_type, shop_id, supplier_id |

### repair_type（修理メニュー）とparts_type（パーツ）の対応
| repair_type | parts_type（色なし） | parts_type（色あり） |
|-------------|---------------------|---------------------|
| TH-F | TH | TH-白 or TH-黒 |
| TH-L | TH | TH-白 or TH-黒 |
| HG-F | HG | HG-白 or HG-黒 |
| HG-L | HG | HG-白 or HG-黒 |
| バッテリー | バッテリー | バッテリー |
| HGバッテリー | HGバッテリー | HGバッテリー |
| コネクタ | コネクタ | コネクタ |
| リアカメラ | リアカメラ | リアカメラ |
| インカメラ | インカメラ | インカメラ |
| カメラ窓 | カメラ窓 | カメラ窓 |

### 色区別モデル
- SE, 6s, 7, 7P, 8, 8P: パネルに白/黒の区別あり

### HGなしモデル
- SE, 6s, 7, 7P: HGパネル、HGバッテリーなし

---

## 2. 発見した問題

### 問題1: 売上登録時にパーツ在庫を減らす処理がない
- 売上を登録しても在庫が減らない
- 実在庫と記録が乖離する

### 問題2: 12Proのパーツ在庫データがない
- m_repair_prices_iphoneには12Proの修理価格あり
- t_parts_inventoryに12Proのレコードなし

### 問題3: 8/8PのHGバッテリーの不整合
- t_parts_inventoryにHGバッテリーあり
- m_repair_prices_iphoneにHGバッテリーなし（修理メニューとして選べない）

### 問題4: SEのカメラ窓
- m_repair_prices_iphoneにカメラ窓あり
- t_parts_inventoryにカメラ窓なし
- SE初代にはカメラ窓パーツが存在しないため、修理価格からも削除すべき

---

## 3. あるべき姿

### データの整合性
1. 修理価格に存在するメニュー ⇔ パーツ原価に対応するパーツが存在
2. パーツ原価に存在するパーツ ⇔ パーツ在庫に対応するレコードが存在
3. 全機種で統一されたデータ構造

### 処理フロー
```
売上登録 → 修理価格から金額取得
         → パーツ原価から原価取得
         → パーツ在庫を1つ減らす（TH-F/TH-Lは同じパーツ）
```

### パーツの並び順（全画面統一）
1. THパネル（黒が先、白が後）
2. HGパネル（黒が先、白が後）
3. バッテリー
4. HGバッテリー
5. コネクタ
6. リアカメラ
7. インカメラ
8. カメラ窓

---

## 4. 必要な修正

### DB修正
1. 12Proのパーツ在庫データ追加
2. 8/8Pの修理価格にHGバッテリー追加
3. SEの修理価格からカメラ窓削除

### コード修正
1. 売上登録時にパーツ在庫を減らす処理を追加
2. 全画面でパーツ順序を統一

### SQLファイル修正
1. 上記DB修正を反映した正しいSQLを生成
